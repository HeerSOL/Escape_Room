<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room: Das Geheimnis des Schlosses</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .leaderboard-container {
            flex: 1;
            min-width: 250px;
            max-width: 350px;
        }
        .game-container {
            flex: 2;
            min-width: 350px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4 space-x-8">

    <!-- Bestenliste (versteckt bis Spielstart) -->
    <div id="leaderboard" class="bg-gray-800 p-8 md:p-12 rounded-2xl shadow-2xl leaderboard-container hidden">
        <h2 id="leaderboard-title" class="text-2xl md:text-3xl font-bold text-teal-400 mb-4 text-center">Bestenliste</h2>
        <div id="leaderboard-results" class="space-y-4">
            <!-- Dynamisch generierte Ergebnisse werden hier eingefügt -->
        </div>
    </div>

    <!-- Hauptspiel-UI -->
    <div class="bg-gray-800 p-8 md:p-12 rounded-2xl shadow-2xl game-container text-center border-2 border-gray-700">
        <h1 id="welcome-message" class="text-3xl md:text-4xl font-bold text-teal-400 mb-2">Willkommen beim Escape Room</h1>
        <p class="text-gray-400 mb-8">Lösen Sie das Rätsel, um die Zeit zu stoppen!</p>

        <!-- Start-Bildschirm -->
        <div id="start-screen" class="space-y-6">
            <input type="text" id="playerName" placeholder="Gib deinen Namen ein..."
                   class="w-full p-3 rounded-lg bg-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-400 transition-all duration-300">
            <button id="startButton"
                    class="w-full px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                Spiel starten
            </button>
        </div>

        <!-- Spiel-UI (versteckt bis Spielstart) -->
        <div id="game-ui" class="space-y-6 hidden">
            <!-- Anzeige für Mission und Fortschritt -->
            <div class="bg-gray-700 p-4 rounded-xl">
                <h2 class="text-xl md:text-2xl font-semibold text-gray-200 mb-2">Aktuelle Mission: <span id="mission-display">1</span></h2>
                <div class="text-gray-300">Gelöste Aufgaben: <span id="progress-display">0/3</span></div>
            </div>

            <div class="bg-gray-700 p-4 rounded-xl">
                <h2 class="text-xl md:text-2xl font-semibold text-gray-200 mb-2">Verstrichene Zeit:</h2>
                <div id="timer" class="text-5xl md:text-6xl font-extrabold text-lime-400 tracking-wide transition-colors duration-500">00:00</div>
            </div>

            <div class="bg-gray-700 p-4 rounded-xl flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <input type="text" id="loesung" placeholder="Geben Sie hier Ihre Lösung ein"
                       class="flex-grow p-3 rounded-lg bg-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-400 transition-all duration-300">
                <button id="checkButton"
                        class="w-full md:w-auto px-6 py-3 bg-teal-500 hover:bg-teal-600 text-white font-bold rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                    Lösung prüfen
                </button>
            </div>
            
            <div class="bg-gray-700 p-4 rounded-xl">
                <button id="tipButton"
                        class="w-full px-6 py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                    Tipp holen (+<span id="tip-cost-display">30s</span>)
                </button>
            </div>
        </div>

        <div id="message" class="mt-8 p-4 rounded-lg text-white font-semibold hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC1IonsQ6OTAz41k8V4JtEzgwReU9fPmhk",
            authDomain: "escape-c96da.firebaseapp.com",
            projectId: "escape-c96da",
            storageBucket: "escape-c96da.firebasestorage.app",
            messagingSenderId: "1011733799997",
            appId: "1:1011733799997:web:590530a563a1a4fb9c7654"
        };
        
        // Initialize Firebase
        let app, db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        document.addEventListener('DOMContentLoaded', async () => {
            const welcomeMessageElement = document.getElementById('welcome-message');
            const playerNameInput = document.getElementById('playerName');
            const startButton = document.getElementById('startButton');
            const startScreen = document.getElementById('start-screen');
            const gameUI = document.getElementById('game-ui');
            const leaderboardElement = document.getElementById('leaderboard');
            const leaderboardResultsElement = document.getElementById('leaderboard-results');
            const timerElement = document.getElementById('timer');
            const loesungInput = document.getElementById('loesung');
            const checkButton = document.getElementById('checkButton');
            const tipButton = document.getElementById('tipButton');
            const messageElement = document.getElementById('message');
            const missionDisplay = document.getElementById('mission-display');
            const progressDisplay = document.getElementById('progress-display');
            const tipCostDisplay = document.getElementById('tip-cost-display');
            const leaderboardTitle = document.getElementById('leaderboard-title');

            // Initialize Firebase services
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Fehler beim Laden des Spiels. Bitte versuchen Sie es erneut.", 'bg-red-600');
            }

            // Spielstatus-Variablen
            let timeInSeconds = 0; // Timer startet bei 0 und zählt hoch
            let phaseStartTime = 0; // Startzeit für jede Phase
            let timerInterval;
            let currentMission = 1;
            let solutionsSolved = 0;
            let tipsGivenForCurrentSolution = 0;
            const leaderboardResults = [];

            // Definition der Lösungen für jede Mission
            const missionSolutions = {
                1: ['21490', '12148', '01912'], // 3 Lösungen für Mission 1
                2: ['buch', 'spiegel', 'bild', 'uhr', 'diamant'] // 5 Lösungen für Mission 2
            };

            // Tipp-Texte für jede Lösung (jeweils bis zu 8 Tipps)
            const missionTips = {
                1: [
                    // Tipps für Lösung 1 (Phase 1: 21490)
                    ['Tipp 1.1: Es geht um das Morse-Alphabet. Das ausgedruckte Dokument enthält eine Übersetzungstabelle.', 'Tipp 1.2: Verwenden Sie die Morse-Tabelle, um die Zeichen zu übersetzen. Das erste Zeichen ist ein "Z".', 'Tipp 1.3: In jeder Zeile wird eine Zahl buchstabiert. In der ersten Zeile: "ZWEI".', 'Tipp 1.4: Arbeiten Sie sich langsam durch den Morse-Code. Die zweite Reihe bedeutet "EINS".', 'Tipp 1.5: Es gibt nicht viele Zahlen, die mit "V" und "N" anfangen. Die dritte Reihe ist "VIER".', 'Tipp 1.6: Die vierte Reihe ist "NEUN".', 'Tipp 1.7: Sie sollten insgesamt fünf Ziffern decodiert haben.', 'Tipp 1.8: Der Code ist "21490".'],
                    // Tipps für Lösung 2 (Phase 2: 12148)
                    ['Tipp 2.1: Der Code ist in dem Puzzle versteckt. Schneiden Sie die Teile aus.', 'Tipp 2.2: Orientieren Sie sich an der dicken, schwarzen Umrandung.', 'Tipp 2.3: Die erste Zeile des Puzzles ergibt "CODE:".', 'Tipp 2.4: Die Zahl unten links ist eine "1".', 'Tipp 2.5: Die einzige Zahl, die neben die "1" passt, ist die "2".', 'Tipp 2.6: Eine weitere "1" folgt der "2".', 'Tipp 2.7: Die vierte Zahl ist eine "4".', 'Tipp 2.8: Die letzte Ziffer ist eine "8". Der vollständige Code lautet "12148".'],
                    // Tipps für Lösung 3 (Phase 3: 01912)
                    ['Tipp 3.1: Es scheint kein normales Rätsel zu sein. "21610" ist nicht der gesuchte Code.', 'Tipp 3.2: Beachten Sie die Striche und Punkte oberhalb und unterhalb der Zahl.', 'Tipp 3.3: Die Striche und Punkte sind Morse-Codes. Der obere Code bedeutet "UNTEN".', 'Tipp 3.4: Der untere Morse-Code bedeutet "OBEN".', 'Tipp 3.5: Die Positionen von "OBEN" und "UNTEN" sind vertauscht.', 'Tipp 3.6: Versuchen Sie, das Papier zu drehen und den Code auf dem Kopf stehend zu lesen.', 'Tipp 3.7: Auf dem Kopf stehend gelesen steht dort "01912".', 'Tipp 3.8: Der Code ist "01912".']
                ],
                2: [
                    // Tipps für Mission 2 (5 Lösungen * 8 Tipps)
                    ['Tipp 1.1', 'Tipp 1.2', 'Tipp 1.3', 'Tipp 1.4', 'Tipp 1.5', 'Tipp 1.6', 'Tipp 1.7', 'Tipp 1.8'],
                    ['Tipp 2.1', 'Tipp 2.2', 'Tipp 2.3', 'Tipp 2.4', 'Tipp 2.5', 'Tipp 2.6', 'Tipp 2.7', 'Tipp 2.8'],
                    ['Tipp 3.1', 'Tipp 3.2', 'Tipp 3.3', 'Tipp 3.4', 'Tipp 3.5', 'Tipp 3.6', 'Tipp 3.7', 'Tipp 3.8'],
                    ['Tipp 4.1', 'Tipp 4.2', 'Tipp 4.3', 'Tipp 4.4', 'Tipp 4.5', 'Tipp 4.6', 'Tipp 4.7', 'Tipp 4.8'],
                    ['Tipp 5.1', 'Tipp 5.2', 'Tipp 5.3', 'Tipp 5.4', 'Tipp 5.5', 'Tipp 5.6', 'Tipp 5.7', 'Tipp 5.8']
                ]
            };

            // Tipp-Kosten: 30s, 1min, 1min30, 2min, 2min30, 3min, 3min30, 4min
            const tipCosts = [30, 60, 90, 120, 150, 180, 210, 240];

            function startTimer() {
                timerInterval = setInterval(() => {
                    timeInSeconds++;
                    updateTimerDisplay();
                }, 1000);
            }

            function updateTimerDisplay() {
                const minutes = Math.floor(timeInSeconds / 60);
                const seconds = timeInSeconds % 60;
                timerElement.textContent = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            }

            function updateProgressDisplay() {
                progressDisplay.textContent = `${solutionsSolved}/${missionSolutions[currentMission].length}`;
                updateTipButtonText();
            }
            
            async function updateLeaderboardDisplay(mission, phase) {
                leaderboardTitle.textContent = `Bestenliste für Mission ${mission}, Phase ${phase}`;
                leaderboardResultsElement.innerHTML = ''; // Liste leeren

                const userId = auth.currentUser ? auth.currentUser.uid : 'anonymous';
                const leaderboardRef = collection(db, `artifacts/${appId}/users/${userId}/leaderboard`);

                const q = query(leaderboardRef, 
                    where("mission", "==", mission),
                    where("phase", "==", phase)
                );
                
                try {
                    const querySnapshot = await getDocs(q);
                    const results = [];
                    querySnapshot.forEach((doc) => {
                        results.push(doc.data());
                    });

                    // Sortiere die Ergebnisse in aufsteigender Reihenfolge nach Zeit
                    results.sort((a, b) => a.time - b.time);

                    results.forEach((result, index) => {
                        const minutes = Math.floor(result.time / 60);
                        const seconds = result.time % 60;
                        const displayTime = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                        
                        const resultHtml = `
                            <div class="bg-gray-700 p-4 rounded-xl text-left flex justify-between items-center">
                                <div>
                                    <p class="text-gray-300 font-semibold">${index + 1}. Platz: ${result.playerName}</p>
                                </div>
                                <div>
                                    <p class="text-lime-400 text-xl font-bold">${displayTime}</p>
                                </div>
                            </div>
                        `;
                        leaderboardResultsElement.innerHTML += resultHtml;
                    });
                } catch (e) {
                    console.error("Fehler beim Abrufen der Rangliste: ", e);
                    showMessage("Fehler beim Laden der Bestenliste.", 'bg-red-600');
                }
            }

            function updateTipButtonText() {
                const currentTips = missionTips[currentMission][solutionsSolved];
                const nextTipIndex = tipsGivenForCurrentSolution;
                if (nextTipIndex < currentTips.length) {
                    const costInSeconds = tipCosts[nextTipIndex];
                    const minutes = Math.floor(costInSeconds / 60);
                    const seconds = costInSeconds % 60;
                    const costString = (minutes > 0 ? `${minutes}m` : '') + (seconds > 0 ? `${seconds}s` : '');
                    tipButton.innerHTML = `Tipp holen (+<span id="tip-cost-display">${costString}</span>)`;
                } else {
                    tipButton.textContent = 'Keine Tipps mehr verfügbar';
                    tipButton.disabled = true;
                    tipButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            function showMessage(msg, type) {
                messageElement.textContent = msg;
                messageElement.className = 'mt-8 p-4 rounded-lg text-white font-semibold';
                messageElement.classList.add(type);
                messageElement.classList.remove('hidden');
            }

            function disableButtons() {
                checkButton.disabled = true;
                tipButton.disabled = true;
                checkButton.classList.add('opacity-50', 'cursor-not-allowed');
                tipButton.classList.add('opacity-50', 'cursor-not-allowed');
            }

            // Lösung prüfen
            checkButton.addEventListener('click', async () => {
                const loesung = loesungInput.value.trim().toLowerCase();
                const expectedSolution = missionSolutions[currentMission][solutionsSolved];

                if (loesung === expectedSolution) {
                    const phaseDuration = timeInSeconds - phaseStartTime;
                    
                    const newResult = {
                        mission: currentMission,
                        phase: solutionsSolved + 1,
                        time: phaseDuration,
                        playerName: playerNameInput.value || 'Anonym'
                    };
                    
                    // Daten in Firestore speichern
                    try {
                        const userId = auth.currentUser ? auth.currentUser.uid : 'anonymous';
                        const leaderboardRef = collection(db, `artifacts/${appId}/users/${userId}/leaderboard`);
                        await addDoc(leaderboardRef, newResult);
                        console.log("Ergebnis in Firestore gespeichert.");
                    } catch (e) {
                        console.error("Fehler beim Hinzufügen des Dokuments: ", e);
                        showMessage("Fehler beim Speichern des Ergebnisses.", 'bg-red-600');
                    }
                    
                    // Aktualisiere die Bestenliste mit den Ergebnissen der aktuellen Phase
                    await updateLeaderboardDisplay(currentMission, solutionsSolved + 1);
                    
                    phaseStartTime = timeInSeconds; // Startzeit für die nächste Phase zurücksetzen

                    solutionsSolved++;
                    tipsGivenForCurrentSolution = 0; // Tipps für die nächste Lösung zurücksetzen
                    showMessage(`Richtig! "${loesung}" war die korrekte Lösung.`, 'bg-green-600');
                    loesungInput.value = '';
                    updateProgressDisplay();
                    
                    if (solutionsSolved === missionSolutions[currentMission].length) {
                        // Mission abgeschlossen
                        if (currentMission === 1) {
                            showMessage('Mission 1 abgeschlossen! Bereit für die nächste Herausforderung.', 'bg-teal-600');
                            currentMission = 2;
                            solutionsSolved = 0;
                            missionDisplay.textContent = currentMission;
                            setTimeout(updateProgressDisplay, 500); // UI-Update mit leichter Verzögerung
                        } else if (currentMission === 2) {
                            // Spielende
                            clearInterval(timerInterval);
                            const finalTime = timerElement.textContent;
                            showMessage(`Herzlichen Glückwunsch! Sie haben den Escape Room in ${finalTime} gelöst!`, 'bg-green-600');
                            disableButtons();
                        }
                    }
                } else {
                    showMessage('Falsche Lösung, versuchen Sie es noch einmal.', 'bg-red-600');
                    loesungInput.value = '';
                }
            });

            // Tipp holen
            tipButton.addEventListener('click', () => {
                const currentTips = missionTips[currentMission][solutionsSolved];
                
                if (tipsGivenForCurrentSolution < currentTips.length) {
                    const costInSeconds = tipCosts[tipsGivenForCurrentSolution];
                    timeInSeconds += costInSeconds;
                    
                    const minutes = Math.floor(costInSeconds / 60);
                    const seconds = costInSeconds % 60;
                    const costString = (minutes > 0 ? `${minutes}min ` : '') + (seconds > 0 ? `${seconds}s` : '');
                    
                    showMessage(`Ein Tipp wurde gewährt! ${costString} wurden zur Zeit hinzugefügt. ${currentTips[tipsGivenForCurrentSolution]}`, 'bg-yellow-600');
                    tipsGivenForCurrentSolution++;
                    updateTimerDisplay();
                    updateTipButtonText();
                } else {
                    showMessage('Es gibt keine weiteren Tipps für diese Mission.', 'bg-red-600');
                }
            });

            // Spielstart
            startButton.addEventListener('click', () => {
                const playerName = playerNameInput.value.trim();
                if (playerName) {
                    welcomeMessageElement.textContent = `Willkommen, ${playerName}!`;
                    startScreen.classList.add('hidden');
                    gameUI.classList.remove('hidden');
                    leaderboardElement.classList.remove('hidden');
                    startTimer();
                    phaseStartTime = timeInSeconds;
                } else {
                    showMessage('Bitte geben Sie einen Namen ein, um das Spiel zu starten.', 'bg-red-600');
                }
            });

            // Initialisierung bei Laden der Seite
            updateProgressDisplay();
        });
    </script>
</body>
</html>
