<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room - Mission Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #764ba2;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .timer-display {
            text-align: center;
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            font-family: 'Courier New', monospace;
        }

        .login-section, .game-section {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group {
            margin-bottom: 20—Ä–µ–º–µ–Ω–¥;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .mission-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .mission-title {
            font-size: 1.5em;
            color: #764ba2;
            margin-bottom: 10px;
        }

        .phase-info {
            color: #666;
            margin-bottom: 5px;
        }

        .hints-section {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 10px;
            border: 2px solid #ffc107;
        }

        .hints-title {
            color: #856404;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .hint-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .hint-btn {
            background: #ffc107;
            color: #000;
            padding: 8px;
            font-size: 14px;
            border-radius: 5px;
            position: relative;
        }

        .hint-btn:hover {
            background: #ffb300;
        }

        .hint-btn.used {
            background: #6c757d;
            color: white;
        }

        .time-penalty {
            font-size: 10px;
            display: block;
            margin-top: 2px;
        }

        .success-message {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            animation: pulse 0.5s;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .error-message {
            background: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .completion-screen {
            text-align: center;
            padding: 40px;
            animation: fadeIn 0.5s;
        }

        .completion-screen h2 {
            color: #28a745;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .final-time {
            font-size: 2em;
            color: #764ba2;
            margin: 20px 0;
        }

        .hint-display {
            background: #e7f5ff;
            border: 2px solid #339af0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            color: #1864ab;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Escape Room</h1>
        
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <div class="input-group">
                <label for="teamName">Team Name eingeben:</label>
                <input type="text" id="teamName" placeholder="Euer Teamname...">
            </div>
            <button onclick="startGame()">Mission starten</button>
            <div id="loginError" class="error-message hidden"></div>
        </div>

        <!-- Game Section -->
        <div id="gameSection" class="game-section hidden">
            <div class="timer-display" id="timer">00:00:00</div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%">
                    <span id="progressText">0%</span>
                </div>
            </div>

            <div class="mission-info">
                <div class="mission-title" id="missionTitle">Mission 0</div>
                <div class="phase-info" id="phaseInfo">Phase 1 von 3</div>
            </div>

            <div class="input-group">
                <label for="solutionInput">L√∂sung eingeben:</label>
                <input type="text" id="solutionInput" placeholder="Eure Antwort...">
            </div>
            <button onclick="checkSolution()">L√∂sung pr√ºfen</button>

            <div id="feedbackMessage" class="hidden"></div>

            <div class="hints-section">
                <div class="hints-title">üí° Hinweise (kosten Zeit!)</div>
                <div class="hint-buttons" id="hintButtons"></div>
                <div id="currentHint" class="hint-display hidden"></div>
            </div>
        </div>

        <!-- Completion Screen -->
        <div id="completionScreen" class="completion-screen hidden">
            <h2>üéâ Gl√ºckwunsch!</h2>
            <p>Ihr habt alle Missionen erfolgreich abgeschlossen!</p>
            <div class="final-time" id="finalTime"></div>
            <button onclick="location.reload()">Neues Spiel</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC1IonsQ6OTAz41k8V4JtEzgwReU9fPmhk",
            authDomain: "escape-c96da.firebaseapp.com",
            projectId: "escape-c96da",
            storageBucket: "escape-c96da.firebasestorage.app",
            messagingSenderId: "1011733799997",
            appId: "1:1011733799997:web:590530a563a1a4fb9c7654"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make functions globally available
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
    </script>

    <script>
        // Game state
        let gameState = {
            teamName: '',
            currentMission: 0,
            currentPhase: 0,
            startTime: null,
            totalTime: 0,
            hintsUsed: [],
            phaseCompletions: []
        };

        // Mission structure
        const missions = [
            {
                name: "Mission 0: Trainingsmission",
                phases: [
                    { 
                        solution: "21490", 
                        hints: [
                            "Unsere Experten vor Ort vermuten, dass es hier offenbar um das Morse-Alphabet geht. Im ausgedruckten Dokument befindet sich eine √úbersetzungstabelle!",
                            "Verwenden Sie die Morse-Tabelle, um die Zeichen zu √ºbersetzen. Das erste Zeichen ist offenbar ein 'Z'!",
                            "In jeder Zeile scheint eine Zahl buchstabiert zu werden. In der ersten Zeile: 'ZWEI'.",
                            "Arbeiten Sie sich langsam durch den Morse-Code. Schreiben Sie jede √úbersetzung √ºber den jeweiligen Code. Die zweite Reihe scheint 'EINS' zu bedeuten.",
                            "Es gibt nicht viele Zahlen, die mit 'V' und 'N' anfangen - vielleicht l√§sst sich hier sogar etwas Zeit einsparen?",
                            "Die dritte Reihe: 'VIER'.",
                            "Reihe nummer vier: 'NEUN'.",
                            "Sie sollten insgesamt f√ºnf Ziffern - '21490' decodiert haben. Geben Sie sie hier auf dem Handy ein und dr√ºcken Sie OK!"
                        ] 
                    },
                    { 
                        solution: "12148", 
                        hints: [
                            "Unsere R√§tsel-Experten vor Ort vermuten, dass der Code f√ºr die zweite Phase in diesem Puzzle versteckt ist. Schneiden Sie die einzelnen Teile aus!",
                            "Unsere Experten weisen darauf hin, dass es hilfreich sein k√∂nnte, sich zun√§chst an der dicken, schwarzen Umrandung zu orientieren.",
                            "Die erste Zeile des Puzzles scheint 'CODE:' zu ergeben, was unsere Vermutung best√§tigt. Wir arbeiten an der zweiten Zeile!",
                            "Wir haben nun Informationen √ºber den Code an sich. Die Zahl unten links scheint eine '1' zu sein.",
                            "Es scheint, als w√§re die einzige Zahl, die neben die '1' unten links passt, die '2'.",
                            "Eine weitere '1' scheint der '2' zu folgen.",
                            "Die vierte Zahl ist eine '4'.",
                            "Die letzte Ziffer ist eine '8'. Der vollst√§ndige Code lautet also: '12148'. Geben Sie ihn hier auf dem Handy ein, und beginnen Sie mit der n√§chsten Phase!"
                        ] 
                    },
                    { 
                        solution: "01912", 
                        hints: [
                            "Unsere Experten waren sich unsicher, ob es sich hier √ºberhaupt um ein R√§tsel handelt, aber '21610' scheint nicht der gesuchte Code zu sein!",
                            "Uns ist aufgefallen, dass sich oberhalb und unterhalb der '21610' Striche und Punkte befinden.",
                            "Die Striche und Punkte scheinen Morse-Codes zu sein! Wir arbeiten an der Dechiffrierung!",
                            "Der obere Morse-Code bedeutet offenbar 'UNTEN'.",
                            "Der untere Morse-Code scheint 'OBEN' zu bedeuten. Was soll uns das sagen?",
                            "Uns ist aufgefallen, dass die Positionen von 'OBEN' und 'UNTEN' vertauscht sind.",
                            "Bitte versuchen Sie, das Papier zu drehen und den Code auf dem Kopf stehend zu lesen.",
                            "Auf dem Kopf stehend gelesen steht dort '01912'. Das muss der Code f√ºr diese Phase sein!"
                        ] 
                    }
                ]
            },
            {
                name: "Mission 1: Bahnhof",
                phases: [
                    { 
                        solution: "52347", 
                        hints: [
                            "Dieses R√§tsel ist seltsam - es scheint keine einzige Zahl zu enthalten! Oder etwa doch?",
                            "Unsere R√§tselexperten vermuten, dass es hier nicht (!) darum geht, etwas zu z√§hlen.",
                            "Wir haben das R√§tsel einem Architekten gezeigt. Ihm fiel auf, dass die meisten W√§nde des Labyrinths mit den Au√üenw√§nden verbunden sind - nur wenige sind freistehend.",
                            "M√∂glicherweise hat die L√∂sung etwas mit der Form der freistehenden W√§nde zu tun?",
                            "Wir sind m√∂glicherweise auf dem richtigen Weg - die erste freistehende Wand auf dem Weg zum Ziel hat die Form einer '5'.",
                            "Auf dem Weg zum Ziel ist die n√§chste freistehende Wand geformt wie eine '2'.",
                            "Die dritte Ziffer muss eine '3' sein - das ist die Form der n√§chsten freistehenden Wand auf dem Weg zum Ziel!",
                            "Wir haben die L√∂sung! Vom Eingang zum Ausgang gehend haben die freistehenden W√§nde in diesem Labyrinth die Formen von '52347' - das muss es sein!"
                        ] 
                    },
                    { 
                        solution: "23740", 
                        hints: [
                            "Dieses R√§tsel sieht anders als die anderen aus. Zun√§chst sollten Sie es ausschneiden.",
                            "Unsere Experten vermuten, dass dieses R√§tsel gefaltet werden muss.",
                            "Es scheint, als w√§re das kleine '+' in der Mitte des R√§tsels tats√§chlich ein 'zentraler Punkt' der L√∂sung.",
                            "Versuchen Sie, die vier Ecken auf das kleine '+' zu falten. Ergibt sich ein Bild?",
                            "Unsere Experten konnten den ersten Teil des R√§tsels l√∂sen. ABCD sind demnach: '2374'. Aber was ist mit E?",
                            "Es scheint, dass E auf der R√ºckseite des einmal gefalteten R√§tsels zu finden ist. Vielleicht muss es erneut gefaltet werden?",
                            "Unsere Experten haben die vier Ecken erneut in die Mitte gefaltet: E ist '0'!",
                            "Die L√∂sung f√ºr diese Phase muss also '23740' sein."
                        ] 
                    },
                    { 
                        solution: "53480", 
                        hints: [
                            "Dieses R√§tsel scheint durch reine Logik l√∂sbar zu sein. Unsere Experten empfehlen, M√∂glichkeiten mit 'bekannten' Positionen aufzuschreiben, wie etwa '0xxx5' und '5xxx0'.",
                            "Da die '4' rechts von der '5' steht, ist '0xxx5' keine L√∂sungsm√∂glichkeit.",
                            "Die '3' muss zwischen der '4' und der '5' (die, wie wir herausgefunden haben, die erste Ziffer im Code ist) stehen. Das k√∂nnte bedeuten, dass der Code mit '534' beginnt.",
                            "Angenommen, der Code beginnt mit '534' - dann m√ºssen die letzten zwei Ziffern zusammengez√§hlt '8' ergeben.",
                            "Unsere Arithmetik-Experten sind sich sicher: '8' und '0' ergeben addiert '8'.",
                            "Da '5' und '0' maximalen Abstand halten m√ºssen, muss die '8' zwischen der '0' und der '4' stehen.",
                            "Der L√∂sungscode lautet, so unsere Experten: '53480'.",
                            "Geben Sie '53480' ein und fahren Sie mit der n√§chsten Phase fort!"
                        ] 
                    },
                    { 
                        solution: "13654", 
                        hints: [
                            "Dieses R√§tsel dreht sich offenbar um Schach. Manchmal hilft es, auf die Bewegungsmuster der einzelnen Figuren zu achten.",
                            "Denken Sie daran: T√ºrme k√∂nnen sich nur horizontal und vertikal bewegen, L√§ufer lediglich diagonal. Die Dame kann beides.",
                            "Unsere Experten empfehlen, dieses R√§tsel zu zweit zu l√∂sen: Eine Person liest die Spielz√ºge vor, eine andere zeichnet Sie auf das Spielbrett.",
                            "Das Bewegungsmuster des wei√üen Turms ist eine simple, gerade Linie nach unten. Es k√∂nnte also hier eine '1' gemeint sein.",
                            "Der wei√üe L√§ufer scheint, so unsere Experten, mit seinen Bewegungen eine '3' zu beschreiben.",
                            "Der schwarze L√§ufer scheint mit seiner Bewegung eine '6' zu zeichnen.",
                            "Der schwarze Turm scheint, wenn man seine Bewegung nachverfolgt, eine '5' zu beschreiben.",
                            "Die wei√üe Dame scheint eine '4' auf das Spielbrett zu zeichnen. Das macht '13654' zur L√∂sung dieser Phase!"
                        ] 
                    },
                    { 
                        solution: "32213", 
                        hints: [
                            "In diesem R√§tsel scheint es um das Falten zu gehen. Allerdings steht dort 'tempor√§r' ... wir testen einige Ans√§tze!",
                            "Es ist sehr wichtig, die Paare von Sternen, die im Text benannt sind, pr√§zise aufeinander zu falten.",
                            "Am vielversprechendsten ist es, zun√§chst das zuerst benannte Sternenpaar aufeinander zu falten, das Papier wieder zu entfalten und dann fortzufahren.",
                            "Ein Origami-Spezialist wies uns darauf hin, dass es m√∂glich ist, aus f√ºnf Falzen einen Stern entstehen zu lassen.",
                            "Vielleicht sollen die f√ºnf Falzungen, von denen im Text die Rede ist, das bewirken? Ist das die 'Supernova'?",
                            "Wird das Papier so gefaltet, wie es im Text beschrieben ist, ergibt sich aus den Falzlinien das Bild eines Sterns.",
                            "Der Code h√§ngt mit der Anzahl der Sterne in diesem Bild zusammen.",
                            "Beginnend im Norden und im Uhrzeigersinn: 3, 2, 2, 1 und 3 Sterne in den 'Armen' des Sterns. Das macht '32213'!"
                        ] 
                    }
                ]
            }
        ];

        // Hint time penalties in seconds
        const hintPenalties = [30, 60, 90, 120, 180, 240, 300, 360];

        let timerInterval;

        function startGame() {
            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                document.getElementById('loginError').textContent = 'Bitte Teamnamen eingeben!';
                document.getElementById('loginError').classList.remove('hidden');
                return;
            }

            gameState.teamName = teamName;
            gameState.startTime = Date.now();

            // Save start to Firebase
            saveProgress('game_started');

            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');

            updateMissionDisplay();
            startTimer();
            generateHintButtons();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000) + gameState.totalTime;
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                
                document.getElementById('timer').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                // Check if time limit exceeded (65 minutes = 3900 seconds)
                if (elapsed >= 3900) {
                    gameOver();
                }
            }, 100);
        }

        function updateMissionDisplay() {
            const mission = missions[gameState.currentMission];
            document.getElementById('missionTitle').textContent = mission.name;
            document.getElementById('phaseInfo').textContent = 
                `Phase ${gameState.currentPhase + 1} von ${mission.phases.length}`;
            
            updateProgressBar();
            document.getElementById('solutionInput').value = '';
            document.getElementById('feedbackMessage').classList.add('hidden');
            document.getElementById('currentHint').classList.add('hidden');
            resetHintButtons();
        }

        function updateProgressBar() {
            const totalPhases = missions.reduce((sum, m) => sum + m.phases.length, 0);
            const completedPhases = gameState.phaseCompletions.length;
            const progress = (completedPhases / totalPhases) * 100;
            
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
        }

        function generateHintButtons() {
            const container = document.getElementById('hintButtons');
            container.innerHTML = '';
            
            for (let i = 0; i < 8; i++) {
                const btn = document.createElement('button');
                btn.className = 'hint-btn';
                
                // Only the next hint should be available
                const isNextHint = i === gameState.hintsUsed.length;
                const isUsed = i < gameState.hintsUsed.length;
                
                if (isUsed) {
                    btn.classList.add('used');
                    btn.innerHTML = `
                        Tipp ${i + 1}
                        <span class="time-penalty">Verwendet</span>
                    `;
                } else if (isNextHint) {
                    btn.innerHTML = `
                        Tipp ${i + 1}
                        <span class="time-penalty">+${formatPenalty(hintPenalties[i])}</span>
                    `;
                    btn.onclick = () => useHint(i);
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.3';
                    btn.innerHTML = `
                        Tipp ${i + 1}
                        <span class="time-penalty">Gesperrt</span>
                    `;
                }
                
                container.appendChild(btn);
            }
        }

        function formatPenalty(seconds) {
            if (seconds < 60) return `${seconds}s`;
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return secs > 0 ? `${minutes}:${secs}` : `${minutes}min`;
        }

        function resetHintButtons() {
            gameState.hintsUsed = [];
            generateHintButtons();
        }

        function useHint(index) {
            // Only allow using the next hint in sequence
            if (index !== gameState.hintsUsed.length) return;
            if (gameState.hintsUsed.includes(index)) return;
            
            // Check current total time
            const currentTime = Math.floor((Date.now() - gameState.startTime) / 1000) + gameState.totalTime;
            const timeAfterHint = currentTime + hintPenalties[index];
            
            // Check if hint would exceed time limit
            if (timeAfterHint >= 3900) {
                alert('‚ùå Dieser Tipp w√ºrde das Zeitlimit von 65 Minuten √ºberschreiten!\nDas Spiel w√ºrde sofort beendet werden.\n\nVersucht es ohne diesen Tipp!');
                return;
            }
            
            // Warning at 50 minutes (3000 seconds)
            if (currentTime >= 3000) {
                if (!confirm(`‚ö†Ô∏è WARNUNG: Ihr habt bereits ${Math.floor(currentTime / 60)} Minuten verbraucht!\n\nDieser Tipp kostet ${formatPenalty(hintPenalties[index])} zus√§tzliche Zeit.\nBei 65 Minuten ist das Spiel automatisch beendet!\n\nTipp wirklich verwenden?`)) {
                    return;
                }
            }
            
            // Add time penalty
            gameState.totalTime += hintPenalties[index];
            gameState.hintsUsed.push(index);
            
            // Show hint
            const mission = missions[gameState.currentMission];
            const hint = mission.phases[gameState.currentPhase].hints[index];
            const hintDisplay = document.getElementById('currentHint');
            hintDisplay.innerHTML = `<strong>Tipp ${index + 1}:</strong> ${hint}`;
            hintDisplay.classList.remove('hidden');
            
            // Regenerate buttons to update their states
            generateHintButtons();
        }

        function checkSolution() {
            const input = document.getElementById('solutionInput').value.trim().toLowerCase();
            const mission = missions[gameState.currentMission];
            const correctSolution = mission.phases[gameState.currentPhase].solution;
            
            if (input === correctSolution) {
                // Correct answer
                showFeedback('Richtig! Weiter zur n√§chsten Phase...', 'success');
                
                // Save phase completion
                const phaseId = `M${gameState.currentMission}_P${gameState.currentPhase}`;
                gameState.phaseCompletions.push(phaseId);
                saveProgress(`phase_completed_${phaseId}`);
                
                // Move to next phase
                setTimeout(() => {
                    gameState.currentPhase++;
                    
                    if (gameState.currentPhase >= mission.phases.length) {
                        // Mission complete, move to next mission
                        gameState.currentMission++;
                        gameState.currentPhase = 0;
                        
                        if (gameState.currentMission >= missions.length) {
                            // Game complete!
                            completeGame();
                        } else {
                            updateMissionDisplay();
                        }
                    } else {
                        updateMissionDisplay();
                    }
                }, 1500);
            } else {
                // Wrong answer - add 30 seconds penalty
                gameState.totalTime += 30;
                showFeedback('‚ùå Falsche Antwort! +30 Sekunden Zeitstrafe. Versucht es nochmal!', 'error');
                
                // Check if this pushes over the time limit
                const currentTime = Math.floor((Date.now() - gameState.startTime) / 1000) + gameState.totalTime;
                if (currentTime >= 3900) {
                    setTimeout(() => gameOver(), 100);
                }
            }
        }

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedbackMessage');
            feedback.textContent = message;
            feedback.className = type === 'success' ? 'success-message' : 'error-message';
            feedback.classList.remove('hidden');
        }

        function completeGame() {
            clearInterval(timerInterval);
            const totalTime = Math.floor((Date.now() - gameState.startTime) / 1000) + gameState.totalTime;
            
            // Save completion to Firebase
            saveProgress('game_completed', totalTime);
            
            // Show completion screen
            document.getElementById('gameSection').classList.add('hidden');
            document.getElementById('completionScreen').classList.remove('hidden');
            
            const hours = Math.floor(totalTime / 3600);
            const minutes = Math.floor((totalTime % 3600) / 60);
            const seconds = totalTime % 60;
            document.getElementById('finalTime').textContent = 
                `Gesamtzeit: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function gameOver() {
            clearInterval(timerInterval);
            const totalTime = Math.floor((Date.now() - gameState.startTime) / 1000) + gameState.totalTime;
            
            // Save game over to Firebase
            saveProgress('game_over_time_limit', totalTime);
            
            // Show game over screen
            document.getElementById('gameSection').classList.add('hidden');
            
            // Create and show game over message
            const gameOverHTML = `
                <div class="completion-screen">
                    <h2 style="color: #dc3545;">‚è±Ô∏è Zeit abgelaufen!</h2>
                    <p style="font-size: 1.2em; margin: 20px 0;">Das Zeitlimit von 65 Minuten wurde √ºberschritten.</p>
                    <p>Ihr habt ${gameState.phaseCompletions.length} von ${missions.reduce((sum, m) => sum + m.phases.length, 0)} Phasen geschafft.</p>
                    <div class="final-time">Endzeit: 01:05:00</div>
                    <button onclick="location.reload()">Neues Spiel starten</button>
                </div>
            `;
            
            document.getElementById('completionScreen').innerHTML = gameOverHTML;
            document.getElementById('completionScreen').classList.remove('hidden');
        }

        async function saveProgress(event, totalTime = null) {
            if (!window.db) {
                console.error('Firebase not initialized');
                return;
            }

            try {
                const data = {
                    teamName: gameState.teamName,
                    event: event,
                    timestamp: window.serverTimestamp(),
                    clientTimestamp: new Date().toISOString()
                };

                if (totalTime !== null) {
                    data.totalTime = totalTime;
                }

                if (event.startsWith('phase_completed_')) {
                    data.phasesCompleted = gameState.phaseCompletions.length;
                }

                await window.addDoc(window.collection(window.db, 'escape_room_progress'), data);
                console.log('Progress saved:', event);
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }

        // Allow Enter key to submit solution
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('solutionInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkSolution();
                }
            });
            
            document.getElementById('teamName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    startGame();
                }
            });
        });
    </script>
</body>
</html>
