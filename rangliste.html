<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room Bestenliste</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-gray-800 p-8 md:p-12 rounded-2xl shadow-2xl w-full max-w-4xl text-center border-2 border-gray-700">
        <h1 class="text-4xl md:text-5xl font-bold text-lime-400 mb-2">Bestenliste</h1>
        <p class="text-gray-400 mb-8">Live-Ranking nach Phasen</p>

        <div id="loading" class="text-xl text-gray-400">Lade Bestenliste...</div>

        <div id="scoreboard-container" class="space-y-8 hidden">
            <!-- Mission 1 Sektion -->
            <div>
                <h2 class="text-3xl font-semibold text-teal-400 mb-4">Mission 1</h2>
                <div id="mission1-phases" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Phasen werden hier dynamisch eingefügt -->
                </div>
            </div>

            <!-- Mission 2 Sektion -->
            <div>
                <h2 class="text-3xl font-semibold text-teal-400 mb-4">Mission 2</h2>
                <div id="mission2-phases" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <!-- Phasen werden hier dynamisch eingefügt -->
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const loadingElement = document.getElementById('loading');
            const scoreboardContainer = document.getElementById('scoreboard-container');
            const mission1Container = document.getElementById('mission1-phases');
            const mission2Container = document.getElementById('mission2-phases');

            // Firebase Initialisierung
            const firebaseConfig = {
                apiKey: "AIzaSyC1IonsQ6OTAz41k8V4JtEzgwReU9fPmhk",
                authDomain: "escape-c96da.firebaseapp.com",
                projectId: "escape-c96da",
                storageBucket: "escape-c96da.firebasestorage.app",
                messagingSenderId: "1011733799997",
                appId: "1:1011733799997:web:590530a563a1a4fb9c7654"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            try {
                // Anonyme Anmeldung ist ausreichend, da nur Leserechte benötigt werden
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                loadingElement.textContent = "Fehler beim Laden der Bestenliste.";
                return;
            }

            // Reference zur öffentlichen Game-Results-Sammlung
            const resultsCollectionRef = collection(db, `artifacts/${appId}/public/data/game-results`);

            // Live-Update der Bestenliste
            onSnapshot(resultsCollectionRef, (snapshot) => {
                loadingElement.classList.add('hidden');
                scoreboardContainer.classList.remove('hidden');
                
                // Ergebnisse für jede Phase und Mission verfolgen
                const rankings = {};

                snapshot.docs.forEach(doc => {
                    const result = doc.data();
                    const { mission, phase, time, playerName } = result;

                    if (!rankings[mission]) {
                        rankings[mission] = {};
                    }
                    if (!rankings[mission][phase] || time < rankings[mission][phase].time) {
                        rankings[mission][phase] = { time, playerName };
                    }
                });

                // Mission 1 Rendering
                mission1Container.innerHTML = '';
                for (let i = 1; i <= 3; i++) {
                    const phaseData = rankings['1']?.[i];
                    const bestTimeText = phaseData ? `${Math.floor(phaseData.time / 60)}m ${phaseData.time % 60}s` : '—';
                    const bestPlayerText = phaseData ? phaseData.playerName : 'Noch kein Team';
                    
                    const phaseDiv = document.createElement('div');
                    phaseDiv.className = 'bg-gray-700 p-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105';
                    phaseDiv.innerHTML = `
                        <h3 class="text-xl font-semibold mb-2">Phase ${i}</h3>
                        <div class="text-lime-400 font-extrabold text-3xl md:text-4xl">${bestTimeText}</div>
                        <div class="text-gray-300 mt-2">Team: ${bestPlayerText}</div>
                    `;
                    mission1Container.appendChild(phaseDiv);
                }

                // Mission 2 Rendering
                mission2Container.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    const phaseData = rankings['2']?.[i];
                    const bestTimeText = phaseData ? `${Math.floor(phaseData.time / 60)}m ${phaseData.time % 60}s` : '—';
                    const bestPlayerText = phaseData ? phaseData.playerName : 'Noch kein Team';
                    
                    const phaseDiv = document.createElement('div');
                    phaseDiv.className = 'bg-gray-700 p-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105';
                    phaseDiv.innerHTML = `
                        <h3 class="text-xl font-semibold mb-2">Phase ${i}</h3>
                        <div class="text-lime-400 font-extrabold text-3xl md:text-4xl">${bestTimeText}</div>
                        <div class="text-gray-300 mt-2">Team: ${bestPlayerText}</div>
                    `;
                    mission2Container.appendChild(phaseDiv);
                }
            }, (error) => {
                console.error("Failed to fetch scoreboard data:", error);
                loadingElement.textContent = "Fehler beim Laden der Bestenliste. Bitte die Konsole überprüfen.";
            });
        });
    </script>
</body>
</html>
